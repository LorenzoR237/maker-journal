---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { Image as AstroImage } from "astro:assets";  // ← alias avoids any global name conflicts

// Load every image under /src/images/<category>/<file>
const modules = import.meta.glob(
  "/src/images/*/*.{jpg,JPG,jpeg,JPEG,png,PNG,webp,WEBP,avif,AVIF}",
  { eager: true }
);

const items = Object.entries(modules).map(([path, mod]) => {
  const parts = path.split("/");
  const category = parts[3].toLowerCase();
  const img = (mod as any).default;
  return {
    img,              // ImageMetadata object for <AstroImage />
    src: img.src,     // full file (for lightbox href)
    width: img.width,
    height: img.height,
    category,
    alt: `${category} photo`,
  };
});

const categories = Array.from(new Set(items.map((i) => i.category))).sort();
const toTitle = (s) => s.charAt(0).toUpperCase() + s.slice(1);
---
<BaseLayout title="Photos — All" description="All photos">
  <section class="ph-wrap">
    <div class="ph-tabs" role="tablist" aria-label="Photo categories">
      <a class="ph-tab is-active" role="tab" aria-selected="true" href="/photos">All</a>
      {categories.map((c) => (
        <a class="ph-tab" role="tab" aria-selected="false" href={`/photos/${c}`}>{toTitle(c)}</a>
      ))}
    </div>

    <div class="ph-grid">
      {items.map((it) => (
        <figure class="ph-card" data-category={it.category}>
          <a href={it.src} data-fancybox="gallery">
            <AstroImage
              src={it.img}
              alt={it.alt || ""}
              loading="lazy"
              decoding="async"
              widths={[320, 480, 640, 800, 1024]}
              sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
              formats={["avif", "webp", "jpeg"]}
            />
          </a>
        </figure>
      ))}
    </div>
  </section>

  <style>
    .ph-wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .ph-tabs { display:flex; gap:8px; flex-wrap:wrap; margin:0 0 16px; }
    .ph-tab {
      display:inline-block; padding:8px 12px; border-radius:999px;
      border:1px solid #ddd; text-decoration:none; color:#333; background:#fff;
    }
    .ph-tab.is-active, .ph-tab:focus { border-color:#333; outline:none; }
    .ph-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); gap:12px; }
    .ph-card { border-radius:8px; overflow:hidden; background:#f7f7f7; }
    .ph-card img { width:100%; height:100%; object-fit:cover; display:block; }
    @media (prefers-color-scheme: dark) {
      .ph-tab { border-color:#333; background:#111; color:#ddd; }
      .ph-card { background:#111; }
    }
  </style>
</BaseLayout>

